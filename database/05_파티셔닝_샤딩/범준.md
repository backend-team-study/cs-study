# 05. 파티셔닝, 샤딩
> 고범준

## Replication
> 데이터베이스 복제라고도 하는데, 네트워크로 연결된 스토리지 노드가 동일한 데이터 복사를 유지하는 것을 말합니다.
> 
> 주 목적은 고가용성 읽기, 또는 쓰기 처리량 증가 목적, 또는 지리적 응답 지연 시간 감소 등을 위해서 사용할 수 있습니다. 
- Replica: 각 본사본을 가지고 있는 노드를 의미함.
- Replica Set: 복사본들의 집합을 의미
- 리더와 팔로워를 설정하는 것이 가장 일반적인 복제 유지 방법
- 리더는 데이터 읽기와 쓰기가 가능하고, 팔로워는 읽기만 가능한 방식으로 동작
- 일반적으로는 복제 로그 또는 Stream을 사용해 복제 수행함.

### 동기 VS 비동기 복제
- 복제 입장에서 동기와 비동기 방식은 `다른 레플리카에 복제가 되는 타이밍을 기준으로 구분`
- 동기 방식은 모든 레플리카 셋이 최신 데이터를 저장하는 것을 보장하므로,
리더 노드 `장애 시 다른 노드로 전환하는 것이 비교적 간단함`
- 하지만 `동기 복제는 느리고 특정 레플리카에 장애가 발생하면 쓰기가 중단`되는 단점이 있어서 분산 시스템에서는 비현실적인` 방안일 수 있음
- 비동기 복제는 가용성 측면에서 장점이 있으나, 모든 레플리카에 최신 데이터가 있는지 보장할 수 없음
- 일반적으로는 동기와 비동기 방식을 적절히 혼합한 방법을 사용하여 복제를 수행함


### 새로운 레플리카 추가 시 필요한 과정
- 리더 노드의 스냅샷을 복사해 새로운 팔로워 노드에 저장
- 리더 노드에게 스냅샷 이후의 데이터 변경 내역을 요청
- 리더 노드의 백로그 처리 이후에 발생하는 데이터 변경을 새로운 팔로워 노드에 적용해 동기화 완료

### 고가용성 유지 방식 - 자동 복구 흐름
- 리더 상태 판단: Heartbeat등을 사용하여 리더 노드의 상태를 판단
- 새로운 리더 선출: 리더 노드가 장애로 판단되면, 새로운 리더를 선출. 제어 노드에 의해 리더를 지정하거나
참여 중인 노드 사이에 선발 -> 가장 최신의 데이터를 가지고 있는 노드가 적합
- 시스템 재설정: 클라이언트가 새로운 리더 노드에 쓰기 요청을 보낼 수 있도록 라우팅 처리.

### 자동 복구 흐름의 모호함
- 복구 흐름은 자연스러워 보이지만 모호한 부분이 존재
  - 리더 노드의 장애 여부와 네트워크 장애 구분이 어려움
  - 리더의 마지막 트랜잭션이 처리되지 않은 상태로 리더 노드 장애 발생 시 처리 방안 필요
  - 리더 죽은 판단 기준인 하트 비트에 명확한 기준 필요

### 쓰기 충돌: 충돌 회피
- 쓰기에 Lock을 거는 방식: 특정 레코드를 동기적으로 쓰는 방법으로 충돌 회피 가능
- 다중 리더의 효용 손실: Lock을 사용하면 다중 리더의 이점이 감소될 수 있음
- 쓰기 동작을 동일한 노드를 거치도록 유도
- 완벽한 해결책은 아님: 특정 리더 노드 장애 시 다른 리더에게 쓰기 전달 가능
- 클라이언트 위치 변경: 이상적인 데이터센터 위치 변경으로 인해 쓰기 지연 발생 가능.

## Sharding
- 데이터베이스의 쓰기 부하를 분산하는 것
- 정확히 복제가 아니기 때문에 다중 리더 복제와 다름
- 샤딩은 여러 데이터베이스 노드에 각자 다른 영역의 데이터를 담음
- 두 노드는 서로 데이터를 동기화하지 않음

### 거대한 데이블의 문제점
- 스토리지는 데이터 영속성을 위해 디스크에 파일을 작성
- 서비스가 성장하면 메모리 사이즈보다 데이터 용량이 커짐
- OS레벨에서 캐시하는 범위를 초과하면 Dist I/O가 급등함
- 테이블이 거대해지면 디스크 I/O가 증가하면서 모든 동작이 느려짐

### 해결할 수 있는 원리
- 거대한 테이블이 문제가 되기 때문에 테이블의 사이즈를 줄여줘야 함
- 샤딩을 설명하기 전에 테이블 크기를 줄일 수 있는 파티셔닝으로 원리를 설명
  - 파티셔닝: 스토리지의 파티션을 임의로 나눠주는 것을 의미
- 보통 데이터베이스 시스템에서 제공하는 기능으로 위에서 말한 거대한 테이블 문제를 어느 정도 완화 가능
  - 하지만 결국 하나의 노드가 받는 부하 수는 줄지 않기 때문에 파티셔닝은 스케일 아웃이 아님
- 






## Partitioning
- Partitioning: 논리적으로는 하나의 테이블이지만 내부적으로 여러 테이블로 나눠 관리하는 방법
- SQL PARTITION 키워드로 테이블을 나눌 수 있음
- 사용하는 데이터 인덱스를 여러 개로 분할해 사용하게 됨

### 파티션 키
- 파티션 키: 파티션을 만들 때 어떤 데이터가 어디에 위치할 지 결정하는 키
- DB가 Create, Read, Update, Delete 쿼리를 수행할 때 이 키를 활용할 수 있는 상황이라면 이 키를 활용해 어떤 파티션을 사용할지 선택
- 그 다음 일반적인 방법을 수행

